# NODDiffusion_ROCs

>This was the code used to generate the results in the paper: 
Higher-order Multi-shell Diffusion Measures Complement Tensor Metrics and Volume in Gray Matter When Predicting Age and Cognition published in Neuroimage, March 2022. [(DOI)](https://doi.org/10.1016/j.neuroimage.2022.119063)
>

***Please cite if using any part of this repository:***
Radhakrishnan, H., Bennett, I.J., Stark, C.E.L (2022). Higher-order Multi-shell Diffusion Measures Complement Tensor Metrics and Volume in Gray Matter When Predicting Age and Cognition 
_Neuroimage_, doi: 10.1016/j.neuroimage.2022.119063

*Contact us at hradhakr@uci.edu with any questions!*

The diffusion processing pipeline is similar to that documented [here](https://github.com/StarkLabUCI/Woofusion).
##### Except for the Microstructure Diffusion Toolbox (which can be found [here](https://github.com/robbert-harms/MDT)), all software used can be accessed by [building](https://sylabs.io/guides/3.0/user-guide/build_a_container.html) the NODDiffusion_sing_recipe singularity recipe provided.


Make sure anat and dwi files are in BIDs format before proceeding. (https://github.com/NILAB-UvA/bidsify)
This script assumes each subject has only a single session. It can be easily modified for longitudinal data.
***

#### Setting up config file:
Instructions on __config.sh__

#### Standard order of operations:
1. Preprocess diffusion image.
2. Generate tensor metrics.
3. Generate NODDI metrics.
4. Preprocess structural image.
5. Warp preprocessed T1w to preprocessed B0.
6. Warp diffusion parametric maps to MNI space.
7. Get averaged metrics (diffusion, volume) for each subject in a specified ROI (into an excel sheet).
8. Run ROC specific analysis.
9. Run nChoosek analysis.
***
***
### Preprocessing diffusion image:
#### preprocess_DWI.sh
Uses MRtrix3 to:
1. Denoise diffusion data
2. Correct Gibbs Ringing Artifacts
3. Eddy and motion correct (needs opposite phase encoding scans)
4. Bias field correct
5. Make brain masks.

*Results in derivatives/mrtrix/preprocessed*
##### Usage:
	./preprocess_dwi.sh <config_file> <subject_ID>
***

### Get tensor metrics:
#### get_tensor_metrics.sh
Uses MRtrix3 to estimate tensor metrics and generate ADC maps. First retrieves scans of only low b values.
*Results in derivatives/mrtrix/tensors and derivatives/diffusion_metrics*
##### Usage:
	./get_tensor_metrics.sh <config_file> <subject_ID>
***

### Get NODDI metrics:
#### get_mdt_metrics.sh
Uses the MDT python toolbox to generate NODDI parametric maps after creating a protocol file from the diffusion gradient table.
*Results in derivatives/mdt and derivatives/diffusion_metrics*
##### Usage:
	./get_mdt_metrics.sh <config_file> <subject_ID>
***

### Preprocess structural image:
#### run_fmriprep.sh
Uses fmriprep (https://fmriprep.org/en/20.2.1/) to preprocess the T1-weighted image.
*Results in derivatives/fmriprep*
##### Usage:
	./run_fmriprep.sh <config_file> <subject_ID>
***

### Align structural image to diffusion space:
#### register_b0T1w.sh
Extracts the B0 volumes from the diffusion image, averages across them and aligns the T1w image to that space.
*Results in derivatives/ANTS
##### Usage:
	./align_b0T1w.sh <config_file> <subject_ID> 
***

### Warp diffusion parametric maps to MNI space:
#### transform_dwimni.sh
Transforms NODDI and tensor metrics to MNI space using the B0<->T1w transforms, and the warps generated by fmriprep.
*Results in derivatives/ANTS
##### Usage:
	./transform_dwimni.sh <config_file> <subject_ID> 
***

### Use 3dmaskave to average over ROIs:
(https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dmaskave.html)
***
***
***

# Python files:
#### global_regression.py
Get globally regressed metrics, after passing in separate CSVs of region specific metrics, and gray matter only metrics.
***

####  roc_analysis.py
Logistic regression functions to predict age  or cognition. Used to generate Figures 3, 5, and 7 of the paper.
***

#### nchoosek_parallel.py
Get AUCs for each combination of nChoosek for a given condition (Section 3.3). Can parallelize if multiple cores available.
***

#### nchoosek_plot.py
Plot results from above- used to generate Figures 4, 6 and 8 of the paper.
***


